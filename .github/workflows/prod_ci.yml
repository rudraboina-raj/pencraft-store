name: Prod Pipeline (release)

on:
  push:
    tags:
      - 'v*.*.*'
    branches:
      - 'release/**'
  workflow_dispatch: {}

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  prod-release:
    runs-on: ubuntu-latest
    env:
      REPO: pencraft
      REGION: ${{ secrets.GCP_REGION }}
      PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      BUCKET: ${{ secrets.GCP_PROJECT_ID }}-builds
      GITOPS_REPO: rudraboina-raj/pencraft-gitops
      # GITOPS_PAT must be configured in repo secrets

    steps:
      - name: Checkout repository (full history for tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute RELEASE_TAG
        id: tag
        run: |
          set -euxo pipefail
          REF_NAME="${GITHUB_REF_NAME:-}"
          REF_TYPE="${GITHUB_REF_TYPE:-}"

          if [ -z "$REF_NAME" ]; then
            case "${GITHUB_REF}" in
              refs/tags/*) REF_NAME="${GITHUB_REF#refs/tags/}"; REF_TYPE="tag" ;;
              refs/heads/*) REF_NAME="${GITHUB_REF#refs/heads/}"; REF_TYPE="branch" ;;
              *) REF_NAME="${GITHUB_REF}"; REF_TYPE="other" ;;
            esac
          fi

          if [[ "$REF_TYPE" == "branch" && "$REF_NAME" == release/* ]]; then
            RELEASE="${REF_NAME//\//-}"
          else
            RELEASE="$REF_NAME"
          fi

          echo "RELEASE_TAG=$RELEASE" >> "$GITHUB_OUTPUT"

      - name: Authenticate to Google Cloud
        id: gcp-auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v1
        with:
          export_default_credentials: true
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${REGION}-docker.pkg.dev -q

      - name: Ensure GCS bucket exists
        run: |
          set -euxo pipefail
          gsutil ls gs://$BUCKET || gsutil mb -l $REGION gs://$BUCKET

      - name: Cache Maven local repo
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: maven-

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Build backend (Spring Boot)
        working-directory: java-store
        run: mvn -B -DskipTests package

      - name: Upload backend artifact
        run: gsutil cp java-store/target/*.jar gs://$BUCKET/${{ steps.tag.outputs.RELEASE_TAG }}/backend/ || true

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: frontend/node_modules
          key: node-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: node-

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Build frontend (use npm install)
        working-directory: frontend
        run: |
          npm install
          npm run build

      - name: Upload frontend artifact
        run: gsutil cp -r frontend/build gs://$BUCKET/${{ steps.tag.outputs.RELEASE_TAG }}/frontend/ || true

      - name: Build and tag images (release)
        env:
          RELEASE: ${{ steps.tag.outputs.RELEASE_TAG }}
        run: |
          set -euxo pipefail
          docker build -t ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/java-store:${RELEASE} ./java-store
          docker tag ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/java-store:${RELEASE} ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/java-store:latest
          docker build -t ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/frontend:${RELEASE} ./frontend
          docker tag ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/frontend:${RELEASE} ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/frontend:latest

      - name: Install Trivy CLI
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
          trivy --version

      - name: Trivy Image Scan (fail on HIGH+CRITICAL)
        env:
          RELEASE: ${{ steps.tag.outputs.RELEASE_TAG }}
        run: |
          set -euxo pipefail
          IMG1="${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/java-store:${RELEASE}"
          IMG2="${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/frontend:${RELEASE}"

          trivy image --format table --severity HIGH,CRITICAL --exit-code 0 "$IMG1"
          trivy image --format table --severity HIGH,CRITICAL --exit-code 0 "$IMG2"

      - name: Push images to GAR
        env:
          RELEASE: ${{ steps.tag.outputs.RELEASE_TAG }}
        run: |
          docker push ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/java-store:${RELEASE}
          docker push ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/java-store:latest
          docker push ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/frontend:${RELEASE}
          docker push ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/frontend:latest

      - name: Update GitOps repo â€” update existing 'release' branch (yq)
        env:
          RELEASE: ${{ steps.tag.outputs.RELEASE_TAG }}
          GITOPS_PAT: ${{ secrets.GITOPS_PAT }}
        run: |
          set -euxo pipefail

          echo "Cloning GitOps repo: ${GITOPS_REPO}"
          git clone https://x-access-token:${GITOPS_PAT}@github.com/${GITOPS_REPO}.git gitops
          cd gitops

          git config user.email "rudraboina0435@gmail.com"
          git config user.name "Rudraboina Rajashekar"

          # ALWAYS update the fixed 'release' branch
          BRANCH="release"
          echo "Updating branch: ${BRANCH}"

          # ensure branch exists
          if ! git ls-remote --heads origin "${BRANCH}" | grep -q "${BRANCH}"; then
            echo "ERROR: Branch '${BRANCH}' does not exist in GitOps repo"
            exit 1
          fi

          git fetch origin ${BRANCH}
          git checkout ${BRANCH}
          git pull origin ${BRANCH}

          export NEW_BACKEND="${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/java-store:${RELEASE}"
          export NEW_FRONTEND="${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/frontend:${RELEASE}"

          echo "NEW_BACKEND=${NEW_BACKEND}"
          echo "NEW_FRONTEND=${NEW_FRONTEND}"

          # install yq if needed
          if ! command -v yq >/dev/null 2>&1; then
            wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
            chmod +x /usr/local/bin/yq
          fi

          echo "Before update (envs/prod/values-prod.yaml):"
          sed -n '1,200p' envs/prod/values-prod.yaml || true
          echo "----------"

          yq eval -i '.backend.image = strenv(NEW_BACKEND)' envs/prod/values-prod.yaml
          yq eval -i '.frontend.image = strenv(NEW_FRONTEND)' envs/prod/values-prod.yaml

          echo "After update (envs/prod/values-prod.yaml):"
          sed -n '1,200p' envs/prod/values-prod.yaml || true
          echo "----------"

          git add envs/prod/values-prod.yaml

          if git diff --cached --quiet -- envs/prod/values-prod.yaml; then
            echo "No changes to commit."
          else
            git commit -m "chore(release): update prod images to ${RELEASE}"
            git push https://x-access-token:${GITOPS_PAT}@github.com/${GITOPS_REPO}.git ${BRANCH}
          fi

          echo "GitOps update complete."
